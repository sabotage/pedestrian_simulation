# 🎬 预置场景说明 / Preset Scenarios Guide

本文档详细介绍了系统中包含的5个预置城市场景及其使用方法。

This document provides detailed information about the 5 preset urban scenarios included in the system.

---

## 📋 场景列表 / Scenario List

### 1. 🏙️ 繁忙街道 (Downtown Street)

#### 环境特征 / Environment Features
- **尺寸**: 100m × 40m
- **人数范围**: 500-1500人 (推荐: 1000)
- **速度分布**: 1.0-1.8 m/s

#### 结构组成 / Structure Components
```
┌─────────────────────────────────────────────────────────┐
│  建筑  [🏢]     人行道     [🌳🚏🌳]     建筑  [🏢]     │
├─────────────────────────────────────────────────────────┤
│           上侧人行道 (5-8m)                              │
├─────────────────────────────────────────────────────────┤
│                车行道 (向东)                             │
├═══════════════════════════════════════════════════════┤
│           中央隔离带 [||||||||]                         │
├═══════════════════════════════════════════════════════┤
│                车行道 (向西)                             │
├─────────────────────────────────────────────────────────┤
│           下侧人行道 (5-8m)                              │
├─────────────────────────────────────────────────────────┤
│  建筑  [🏢]     人行道     [🌳🚏🌳]     建筑  [🏢]     │
└─────────────────────────────────────────────────────────┘
   🚇                                                🚇
  地铁站                                          地铁站
```

#### 关键区域 / Key Areas
- **出入口**: 
  - 地铁站出口 (左右两端，高流量: 8 peds/sec)
  - 公交站 (中间位置，3 peds/sec)
  - 商店入口 (4个，各2 peds/sec)
- **障碍物**: 树木、广告牌、座椅
- **人行横道**: 3处横穿点 (隔离带开口处)

#### 推荐突发事件 / Recommended Events
1. **交通信号异常** (10秒时):
   - 类型: 入口封闭 (模拟红绿灯失效)
   - 位置: 人行横道处
   
2. **道路施工** (20秒时):
   - 类型: 区域封闭
   - 效果: 一侧人行道封闭，行人改道
   
3. **火灾事件** (30秒时):
   - 类型: 火灾
   - 位置: (50, 35) 公交站附近
   - 半径: 8m

#### 模拟目标 / Simulation Goals
- ✅ 分析人流瓶颈点 (人行横道)
- ✅ 测试避障行为 (树木、座椅)
- ✅ 模拟红灯等待与改道
- ✅ 评估突发封闭后的人群重分布

---

### 2. 🎓 大学校园 (Campus)

#### 环境特征 / Environment Features
- **尺寸**: 120m × 100m
- **人数范围**: 500-3000人 (推荐: 2000)
- **速度分布**: 1.2-1.6 m/s (学生为主)

#### 结构组成 / Structure Components
```
                       正门 🚪
                         ↓
┌───────────────────────────────────────────────────┐
│                                                   │
│   教学楼A        主干道        教学楼B            │
│   [🏫]      ════╬════      [🏫]                   │
│                 ║                                 │
│ ───────────────╬──────────── 横向主干道          │
│                 ║                                 │
│                食堂                                │
│               [🍽️]                               │
│                 ║                                 │
│   宿舍楼         ║         图书馆                 │
│   [🏠]      ════╬════      [📚]                   │
│                 ║                                 │
└─────────────────┼─────────────────────────────────┘
     西门🚪      后门🚪      东门🚪
```

#### 关键区域 / Key Areas
- **出入口**:
  - 正门: 10 peds/sec (主要人流)
  - 西门/东门: 各5 peds/sec
  - 后门: 3 peds/sec
- **建筑入口**:
  - 教学楼A/B: 各6 peds/sec
  - 食堂: 7 peds/sec (高峰)
  - 图书馆: 5 peds/sec
  - 宿舍: 4 peds/sec
- **道路网络**: 十字主干道 + 支路

#### 推荐突发事件 / Recommended Events
1. **上课铃响** (5秒时):
   - 大量学生从宿舍涌向教学楼
   - 方向: 宿舍 → 教学楼

2. **火灾警报** (30秒时):
   - 类型: 火灾
   - 位置: (27, 25) 教学楼A中心
   - 半径: 15m
   - 效果: 建筑内学生紧急疏散

3. **正门封闭** (45秒时):
   - 类型: 入口封闭
   - 效果: 学生改用西门/东门

#### 模拟目标 / Simulation Goals
- ✅ 多源多目标路径选择
- ✅ 建筑疏散效率评估
- ✅ 不同路径策略下的拥堵分析
- ✅ 高峰期人流管理

---

### 3. 🏥 医院 (Hospital)

#### 环境特征 / Environment Features
- **尺寸**: 90m × 80m
- **人数范围**: 500-1000人 (推荐: 800)
- **速度分布**: 0.5-1.5 m/s (混合人群)

#### 结构组成 / Structure Components
```
             正门 (门诊楼) 🚪
                  ↓
┌─────────────────────────────────────────────────┐
│                                                 │
│           门诊楼 [🏥]                            │
│           ┌─────┐                               │
│           │ 🚑 │ 连接通道                        │
│  急诊楼   └─────┘     住院楼                     │
│  [🚨]    ════════    [🏥]                        │
│    ↑                                            │
│  急救通道                                        │
│                                                 │
└─────────────────────────────────────────────────┘
  🚪后勤入口
```

#### 关键区域 / Key Areas
- **出入口**:
  - 急诊入口: 5 peds/sec (高优先级)
  - 正门 (门诊): 6 peds/sec
  - 住院部入口: 3 peds/sec
  - 后勤入口: 2 peds/sec
- **连接通道**: 建筑间走廊 (瓶颈)
- **救护车通道**: 保持畅通

#### 人群特征 / Pedestrian Characteristics
- **医护人员**: 速度快 (1.4-1.6 m/s), 定向移动
- **病人/访客**: 速度慢 (0.5-1.0 m/s), 随机/陪护
- **优先级**: 医护 > 病人 > 访客

#### 推荐突发事件 / Recommended Events
1. **火灾警报** (15秒时):
   - 类型: 火灾
   - 位置: (52, 25) 门诊楼中心
   - 半径: 12m
   - 特殊: 病人疏散需更多时间

2. **电梯停用** (25秒时):
   - 效果: 楼梯通行拥挤 (模拟)
   - 路径: 强制使用替代路线

3. **急救通道阻塞** (35秒时):
   - 类型: 入口封闭
   - 位置: 急诊入口
   - 效果: 救护车无法到达

#### 模拟目标 / Simulation Goals
- ✅ 疏散策略评估 (病人优先)
- ✅ 电梯/楼梯容量分析
- ✅ 多群体行为对比
- ✅ 急救通道畅通性

---

### 4. 🏬 购物中心 (Shopping Mall)

#### 环境特征 / Environment Features
- **尺寸**: 100m × 80m
- **人数范围**: 1000-5000人 (推荐: 3000)
- **速度分布**: 0.8-1.4 m/s (游逛为主)

#### 结构组成 / Structure Components
```
                     主门 🚪
                       ↓
┌─────────────────────────────────────────────────┐
│                                                 │
│  商铺  商铺         中庭广场          商铺  商铺  │
│  [🛍️] [🛍️]      ┌─────────┐      [🛍️] [🛍️]  │
│                  │         │                   │
│  商铺  商铺      │  休息区  │      商铺  商铺    │
│  [🛍️] [🛍️]      │  [🪑🪑]  │      [🛍️] [🛍️]  │
│                  │         │                   │
│  商铺  商铺      └─────────┘      商铺  商铺    │
│  [🛍️] [🛍️]                       [🛍️] [🛍️]  │
│                                                 │
└─────────────────────────────────────────────────┘
  🚪        🚪 后门 🚪        🚪
停车场入口              停车场入口
  +安全通道×4
```

#### 关键区域 / Key Areas
- **主要入口**:
  - 主门: 15 peds/sec (最高流量)
  - 停车场入口 (东西各一): 各8 peds/sec
  - 后门: 5 peds/sec
- **疏散出口**: 8个 (主门×1, 侧门×2, 后门×1, 安全通道×4)
- **商铺**: 围绕中庭布置
- **中庭**: 开放空间 + 休息区
- **休息区**: 座椅 (行人停留点)

#### 推荐突发事件 / Recommended Events
1. **火灾 + 烟雾扩散** (20秒时):
   - 类型: 火灾
   - 位置: (50, 40) 中庭中心
   - 半径: 20m (大范围)
   - 效果: Panic扩散到整个楼层

2. **电梯/扶梯停用** (30秒时):
   - 效果: 疏散路径限制
   - 模拟: 出口容量减半

3. **突发惊恐事件** (40秒时):
   - 类型: 枪击/爆炸声
   - 位置: (85, 30) 商铺区
   - 半径: 15m
   - 效果: 快速Panic扩散

#### 模拟目标 / Simulation Goals
- ✅ 多层疏散行为分析
- ✅ 拥堵点识别 (扶梯、出口)
- ✅ Panic扩散模型验证
- ✅ 大规模人群疏散效率

---

### 5. 🌳 城市公园 (Urban Park)

#### 环境特征 / Environment Features
- **尺寸**: 100m × 100m
- **人数范围**: 500-2000人 (推荐: 1500)
- **速度分布**: 0.5-1.2 m/s (休闲为主)

#### 结构组成 / Structure Components
```
                     北门 🚪
                       ↓
┌─────────────────────────────────────────────────┐
│  🌳     🌳            🌳      🌳               │
│            活动舞台                             │
│  🌳       [🎭🎤]          🌳       🌳         │
│                                               │
│ 🚪                                          🚪 │
│ 西                  湖泊                    东  │
│ 门   🌳          [🏞️💧]          🌳       门  │
│                 ~~~~~~~                       │
│  🌳              ~~~~~              🌳       │
│                                               │
│       🌳                    餐车区            │
│                         [🍔🍟🌭]             │
│  🌳            🌳              🌳            │
└─────────────────────────────────────────────────┘
        🚪 西南门           🚪 东南门
```

#### 关键区域 / Key Areas
- **出入口** (5个公园大门):
  - 北门: 5 peds/sec
  - 西门/东门: 各4 peds/sec
  - 西南门/东南门: 各3 peds/sec
- **活动区**: 
  - 舞台: 6 peds/sec (活动时高聚集)
- **湖泊**: 中心障碍 (行人绕行)
- **树木**: 21棵散布 (小障碍)
- **餐车区**: 3个餐车 (停留点)

#### 人群行为特征 / Crowd Behavior
- **漫步型**: 70% (随机方向，低速)
- **定向型**: 20% (去特定地点)
- **停留型**: 10% (在休息区/餐车停留)
- **团体**: 60% (2-4人同行)

#### 推荐突发事件 / Recommended Events
1. **活动结束 - 大规模撤离** (10秒时):
   - 场景: 舞台活动结束
   - 效果: 1000人同时从中心区域向各出口疏散
   - 目标: 测试多出口分流效率

2. **突发雷雨** (30秒时):
   - 模拟方法: 全体行人加速 (速度×1.5)
   - 目标: 最近出口
   - 效果: 北门/西门/东门拥堵

3. **恐慌事件** (45秒时):
   - 类型: 枪击
   - 位置: (50, 50) 湖泊附近
   - 半径: 25m (覆盖半个公园)
   - 效果: 人群多方向逃逸

#### 模拟目标 / Simulation Goals
- ✅ 大规模同时疏散流分析
- ✅ 流向分布与瓶颈形成
- ✅ Panic扩散与群体聚散
- ✅ 开放空间路径选择

---

## 🚀 使用方法 / How to Use

### 方法1: 通过Web界面加载 (推荐)

1. **启动服务器**:
   ```bash
   python run.bat   # Windows
   ./run.sh         # Linux/Mac
   ```

2. **打开浏览器**: http://localhost:5000

3. **选择场景**:
   - 在左侧面板顶部 "Preset Scenarios" 下拉菜单中选择场景
   - 例如: "🏙️ Downtown Street / 繁忙街道"

4. **查看场景信息**:
   - 场景描述会自动显示
   - 推荐行人数量会显示
   - 地图会自动加载到画布

5. **开始模拟**:
   - 点击 "▶️ Start" 开始模拟
   - 系统会自动生成推荐数量的行人

6. **添加突发事件**:
   - 在 "Emergency Events" 部分选择事件类型
   - 设置触发时间和位置
   - 点击 "Add Event" 添加

### 方法2: 通过Python脚本

```python
from examples.generate_preset_scenarios import ScenarioGenerator
from src.simulation.simulator import Simulator
import json

# 创建场景生成器
generator = ScenarioGenerator()

# 生成场景 (选择其一)
env = generator.create_downtown_street()
# env = generator.create_campus()
# env = generator.create_hospital()
# env = generator.create_shopping_mall()
# env = generator.create_urban_park()

# 创建模拟器
sim = Simulator(env, dt=0.1)

# 生成行人
for entrance in env.entrances:
    for _ in range(50):  # 每个入口生成50个行人
        sim.spawn_pedestrian()

# 添加突发事件 (例如火灾)
sim.event_manager.schedule_fire(
    trigger_time=10.0,
    position=(50, 40),
    radius=10.0
)

# 运行模拟
for step in range(500):
    sim.step()
    if step % 10 == 0:
        print(f"Time: {sim.time:.1f}s, Active: {sim.stats['active']}")
```

### 方法3: 加载JSON配置文件

```python
import json
from src.simulation.environment import Environment
from src.simulation.simulator import Simulator

# 加载场景配置
with open('scenarios/downtown_street.json', 'r', encoding='utf-8') as f:
    scenario = json.load(f)

# 从配置创建环境
env = Environment.from_dict(scenario['environment'])

# 创建模拟器
sim = Simulator(env, dt=0.1)

# 开始模拟...
```

---

## 📊 性能建议 / Performance Recommendations

| 场景 | 推荐行人数 | 最大行人数 | 推荐帧率 | 内存占用 |
|------|-----------|-----------|---------|---------|
| 🏙️ 繁忙街道 | 1000 | 1500 | 30 FPS | ~200 MB |
| 🎓 大学校园 | 2000 | 3000 | 20 FPS | ~400 MB |
| 🏥 医院 | 800 | 1000 | 30 FPS | ~150 MB |
| 🏬 购物中心 | 3000 | 5000 | 15 FPS | ~600 MB |
| 🌳 城市公园 | 1500 | 2000 | 25 FPS | ~300 MB |

**注意**: 
- 行人数量越多，计算负载越大
- 建议先用较少行人测试，确认场景正常后再增加
- Web界面实时渲染会影响性能，导出到Unity可获得更好表现

---

## 🎯 常见应用场景 / Common Use Cases

### 1. 城市规划
- **场景**: 繁忙街道、城市公园
- **目标**: 评估人行道宽度、出入口设置
- **关键指标**: 拥堵率、平均通行时间

### 2. 建筑设计
- **场景**: 购物中心、医院
- **目标**: 优化出口布局、疏散路线
- **关键指标**: 疏散时间、瓶颈位置

### 3. 应急演练
- **场景**: 全部场景
- **目标**: 测试应急预案、疏散效率
- **关键指标**: 疏散完成时间、伤亡预测

### 4. 科研教学
- **场景**: 大学校园、城市公园
- **目标**: 行人动力学研究、教学演示
- **关键指标**: 社会力模型参数、行为模式

---

## 🔧 自定义场景 / Customizing Scenarios

如果预置场景不满足需求,可以:

1. **修改现有场景**:
   - 编辑 `scenarios/*.json` 文件
   - 调整墙体、出入口位置
   - 修改流量参数

2. **创建新场景**:
   - 参考 `examples/generate_preset_scenarios.py`
   - 继承 `ScenarioGenerator` 类
   - 实现自己的场景生成方法

3. **通过Web界面绘制**:
   - 选择 "Create Custom Environment"
   - 使用绘图工具手动绘制
   - 保存为新场景

---

## 📝 注意事项 / Important Notes

1. **行人生成**:
   - 系统会根据入口的 `flow_rate` 自动生成行人
   - 建议设置合理的流量避免过度拥挤

2. **突发事件时机**:
   - 建议在行人数量达到稳定后触发
   - 给予足够的模拟时间观察效果

3. **Unity导出**:
   - 勾选 "Record for Unity Export" 再开始模拟
   - 导出文件位于 `exports/` 目录

4. **性能优化**:
   - 减少行人数量可提升性能
   - 调大时间步长 (`dt`) 可加快模拟速度

---

## 📚 相关文档 / Related Documentation

- [快速开始指南](QUICKSTART.md) - 基础使用教程
- [技术文档](DOCUMENTATION.md) - API参考
- [架构设计](ARCHITECTURE.md) - 系统架构说明
- [视觉教程](VISUAL_GUIDE.md) - 图文教程

---

**创建日期**: 2024-10-30  
**版本**: 1.0  
**作者**: Pedestrian Simulation Team
